# SFlash - 지도 SNS 서비스 📸✨
[![bg-3.png](https://i.postimg.cc/rsYZfRbT/bg-3.png)](https://postimg.cc/V0nF6vmZ)
<br>

<p align="center">
  <img src="https://img.shields.io/badge/Java-007396?style=flat-square&logo=Java&logoColor=white"/>
  <img src="https://img.shields.io/badge/SpringBoot-6DB33F?style=flat-square&logo=Spring&logoColor=white"/>
  <img src="https://img.shields.io/badge/HTML-E34F26?style=flat-square&logo=html5&logoColor=white"/>
  <img src="https://img.shields.io/badge/CSS-1572B6?style=flat-square&logo=css3&logoColor=white"/>
  <img src="https://img.shields.io/badge/React-61DAFB?style=flat-square&logo=react&logoColor=white"/><br>
  <img src="https://img.shields.io/badge/Json_Web_Tokens-000000?style=flat-square&logo=Json-Web-Tokens&logoColor=white"/>
  <img src="https://img.shields.io/badge/AmazonS3-569A31?style=flat-square&logo=amazon-s3&logoColor=white"/>
  <img src="https://img.shields.io/badge/aws-232F3E?style=flat-square&logo=amazon-aws&logoColor=white"/>
  <img src="https://img.shields.io/badge/MariaDB-003545?style=flat-square&logo=MariaDB&logoColor=white"/>
  <img src="https://img.shields.io/badge/Travis_CI-3EAAAF?style=flat-square&logo=Travis-CI&logoColor=white"/>
  <img src="https://img.shields.io/badge/Gradle-02303A?style=flat-square&logo=Gradle&logoColor=white"/>
  
</p>

# [🏠 HOME PAGE](https://www.sflash.net/)<br>
# [📺프로젝트 시연 영상](https://youtu.be/UdnDlwT31Xk)<br>
## 💡 프로젝트 소개
사람들은 알고 나만 모르는 스팟들…
대체 거기가 어디야? 블로그, 인스타 검색 이제 그만!!
SFlash(Spot + Flash)는 전국의 명소들을 사진과 지도로 한눈에 볼수 있도록 기획한 서비스 입니다.
<br>

#### 👨‍👨‍👦‍👦 팀원
* Frontend : 허민규, 김다영, 김형민 `React`
* Backend : 장현준, 김승욱, 이세정 `SpringBoot`
* Designer : 송은정, 임아현

#### 📅 진행 기간
* 21.04.23(금) - 21.05.28(금)

#### ✍ 기획 배경
* 원하는 장소를 찾기 위해 인스타그램, 블로그 검색 후 해당 장소의 정확한 위치를 찾기 위해 지도로 검색을 해야하는 번거로움 발생
* 사용자들이 원하는 스팟 정보를 지도와 사진으로 한 눈에 볼 수 있도록 기획
<br>


## 💡 개발 환경
* `Java 8`
* `JDK 1.8.0`
* IDE : `IntelliJ`
* Framework : `SpringBoot`
* Build Tools : `Gradle`
* Server : `Amazon EC2 Ubuntu`
* Database : `Amazon RDS MariaDB`
* File Storage: `AWS S3 Bucket`
* CI/CD : `Travis`, `codedeploy`,`s3`
<br>

## 💡 전체 구조
![](https://user-images.githubusercontent.com/55679927/119793545-a778e780-bf11-11eb-946e-581fd2063913.jpeg)


## 💡 주요 기능







| [로그인/회원가입](https://github.com/JangHyeonJun2/picturespot/wiki/%EC%A3%BC%EC%9A%94-%EA%B8%B0%EB%8A%A5-%EC%86%8C%EA%B0%9C#-sflash-%ED%9A%8C%EC%9B%90%EA%B0%80%EC%9E%85-%EB%A1%9C%EA%B7%B8%EC%9D%B8-jwt-%EC%A0%95%EB%A6%AC) | [이메일/비밀번호 찾기](https://github.com/JangHyeonJun2/picturespot/wiki/%EC%A3%BC%EC%9A%94-%EA%B8%B0%EB%8A%A5-%EC%86%8C%EA%B0%9C#-%EC%9D%B4%EB%A9%94%EC%9D%BC%EB%B9%84%EB%B0%80%EB%B2%88%ED%98%B8-%EC%B0%BE%EA%B8%B0) | [소셜 로그인](https://github.com/JangHyeonJun2/picturespot/wiki/%EC%A3%BC%EC%9A%94-%EA%B8%B0%EB%8A%A5-%EC%86%8C%EA%B0%9C#-oauth2-%EC%86%8C%EC%85%9C%EB%A1%9C%EA%B7%B8%EC%9D%B8) | [게시글 CRUD](https://github.com/JangHyeonJun2/picturespot/wiki/%EC%A3%BC%EC%9A%94-%EA%B8%B0%EB%8A%A5-%EC%86%8C%EA%B0%9C/_edit#%EA%B2%8C%EC%8B%9C%EA%B8%80-%EC%9E%91%EC%84%B1) | [다중 이미지 업로드](https://github.com/JangHyeonJun2/picturespot/wiki/%EC%A3%BC%EC%9A%94-%EA%B8%B0%EB%8A%A5-%EC%86%8C%EA%B0%9C#%EB%8B%A4%EC%A4%91-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EC%97%85%EB%A1%9C%EB%93%9C) |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| [![2021-05-31-4-54-56.png](https://i.postimg.cc/qBspRJK7/2021-05-31-4-54-56.png )](https://postimg.cc/gr2CtPN9) | [![2021-05-31-4-56-35.png](https://i.postimg.cc/DwD96HGD/2021-05-31-4-56-35.png )](https://postimg.cc/G4FghMqJ) | ![2021-05-31-4-54-56.png](https://i.postimg.cc/qBspRJK7/2021-05-31-4-54-56.png ) | [![2021-05-31-4-58-55.png](https://i.postimg.cc/qq3ht98T/2021-05-31-4-58-55.png)](https://postimg.cc/N2QfSCJJ) | [![2021-05-31-5-00-07.png](https://i.postimg.cc/g2DssB7p/2021-05-31-5-00-07.png )](https://postimg.cc/Wdd0bSjY) |
| [**댓글CRUD**](https://github.com/JangHyeonJun2/picturespot/wiki/%EC%A3%BC%EC%9A%94-%EA%B8%B0%EB%8A%A5-%EC%86%8C%EA%B0%9C#%EB%8C%93%EA%B8%80crud) | [**좋아요**](https://github.com/JangHyeonJun2/picturespot/wiki/%EC%A3%BC%EC%9A%94-%EA%B8%B0%EB%8A%A5-%EC%86%8C%EA%B0%9C#%EC%A2%8B%EC%95%84%EC%9A%94) | [**프로필 편집**](https://github.com/JangHyeonJun2/picturespot/wiki/%EC%A3%BC%EC%9A%94-%EA%B8%B0%EB%8A%A5-%EC%86%8C%EA%B0%9C#-%EB%A7%88%EC%9D%B4%ED%8E%98%EC%9D%B4%EC%A7%80) | [**문의하기 CRUD**](https://github.com/JangHyeonJun2/picturespot/wiki/%EC%A3%BC%EC%9A%94-%EA%B8%B0%EB%8A%A5-%EC%86%8C%EA%B0%9C#-%EB%AC%B8%EC%9D%98%ED%95%98%EA%B8%B0-%EA%B2%8C%EC%8B%9C%ED%8C%90) | [**문의하기 답변 CRUD**](https://github.com/JangHyeonJun2/picturespot/wiki/%EC%A3%BC%EC%9A%94-%EA%B8%B0%EB%8A%A5-%EC%86%8C%EA%B0%9C#%EB%8C%93%EA%B8%80) |
| [![2021-05-31-5-01-11.png](https://i.postimg.cc/vZ37fx1H/2021-05-31-5-01-11.png )](https://postimg.cc/3k0DHRCP) | [![2021-05-31-5-02-05.png](https://i.postimg.cc/tTPVSsg6/2021-05-31-5-02-05.png )](https://postimg.cc/r0VmzFxy) | [![2021-05-31-5-02-55.png](https://i.postimg.cc/hGQJvXTY/2021-05-31-5-02-55.png)](https://postimg.cc/Y4k2yqXN) | [![2021-05-31-5-03-42.png](https://i.postimg.cc/6pg3kBgf/2021-05-31-5-03-42.png )](https://postimg.cc/0zGPm18z) | [![2021-05-31-5-04-38.png](https://i.postimg.cc/SRSN6RYk/2021-05-31-5-04-38.png )](https://postimg.cc/BLz0sqCV) |

<br>

# 📌 [기술 및 프로젝트 정리 - WIKI](https://github.com/JangHyeonJun2/picturespot/wiki)
<br>
<br>
<br>


# 문제발생 및 해결

### /map(GetMapping), /board(GetMapping) API호출 할 때 시간 최적화 하기 위한 노력

- /map, /board를 호출시 Board,User,Heart,BoardImgUrl에 대한 정보를 한번에 보내주어야한다. 처음 프로젝트를 설계를 하였을 때는 반복문으로 DB를 조회를 하였지만 N + 1문제가 발생하였고, 데이터가 많아 질 수록 조회시간도 더욱 느리게 되었다. 그래서 한번 조회를 할 때 User,Heart,ImgUrl를 다 조회하는 페치조인을 사용하였다. 그 결과 아래 사진과 같이 시간을 축소 시켰습니다.
  [![2021-05-31-8-31-59.png](https://i.postimg.cc/J7Bjh4jv/2021-05-31-8-31-59.png  )](https://postimg.cc/9zCD828Y)

### 무중단 CI/CD

- FileZila를 사용하면서 배포 시간비용이 오래 걸렸고, 배포를 하는 과정에서 서비스가 멈춰야하는 불상사가 나버리는 치명적인 단점이 있다. 그래서 깃헙에서 무료제공중인 travis와 스크립트를 활용하여 무중단 배포를 구현하였습니다. 그 결과 배포과정에서의 시간비용을 최소화할 수 있었고 배포가 되더라도 서비스는 멈추지않는 결과가 나오게 되었습니다.

  [![2021-05-31-8-36-50.png](https://i.postimg.cc/qRwShxfB/2021-05-31-8-36-50.png)](https://postimg.cc/ph9q38X3)

### 제1정규형 위배

- 처음 설계를 하였을 때는 메모리 DB인 H2를 사용하였다.그리고 엔티티 설계를 한 컬럼에 데이터가 2개도 넣을 수 있게 하였다. 즉, 하나의 게시글에 이미지가 1개이상인데 만약 이미지가 2개일 때 하나의 컬럼에 ImgUrl이 2개가 있는것이다. 근데 H2는 이걸 에러를 띄우지 않았다. 그래서 중반(?)까지 가서 눈치를 채게 되었다...!! 정말 치명적인 실수였다. 그래서 BoardImgUrl 엔티티를 만들고 다시 설계를 하는 불상사가 일어났다.

  ```java
  @NoArgsConstructor
  @Getter
  @Entity
  public class BoardImgUrls {
      @Id
      @GeneratedValue(strategy = GenerationType.IDENTITY)
      @Column(name = "BOARDIMGURLS_ID")
      private Long id;
  
      @ManyToOne
      @JoinColumn(name = "BOARD_ID")
      private Board board;
  
      private String imgUrl;
  
      @Builder
      public BoardImgUrls(String imgUrl, Board board) {
          this.imgUrl = imgUrl;
          this.board = board;
      }
  
      public static Set<BoardImgCommonRequestDto> toDtoList(Set<BoardImgUrls> dtos) {
          Set<BoardImgCommonRequestDto> imgCommonRequestDtos = new HashSet<>();
          for (BoardImgUrls boardImgUrl : dtos) {
              imgCommonRequestDtos.add(new BoardImgCommonRequestDto(boardImgUrl));
          }
          return imgCommonRequestDtos;
      }
  }
  ```

### S3 게시글 작성 이미지 업로드 에러

- 1차배포, Http일 때는 이상이 없었다. -> 2차배포, Https 적용하고 나서 게시글 작성시 Permission Error가 발생.

- 블로그와 문서를 찾아보니 S3는 Https를 지원을 안할 수 도 있다? 라는 의견을 보게되었다. 그래서 1차 해결책으로 AWS CLoudFront로 s3를 배포하기로 해보았다. 하지만 실패를 하였고, 스택오버플로우와 블로그, 문서를 찾아보다가 나와 비슷한 문제를 가진 사람이 있었다. 

  ```java
  private Optional<File[]> convert(List<MultipartFile> file) throws IOException {
          multiparts = new MultipartFile[file.size()];
          File[] convertFiles = new File[file.size()];
          for (int i=0; i<file.size(); i++) {
              multiparts[i] = file.get(i);
              convertFiles[i] = new File((file.get(i).getOriginalFilename()));
             if (!convertFiles[i].exists()) {
                log.info("파일이 존재하는지? : " + convertFiles[i].exists()+" ,"+convertFiles[i]);
                  convertFiles[i].mkdirs();
                  Runtime.getRuntime().exec("chmod 777 " + file.get(i).getOriginalFilename());
                  convertFiles[i].setExecutable(true, false);
                  convertFiles[i].setReadable(true, false);
                  convertFiles[i].setWritable(true, false);
                 if (!convertFiles[i].createNewFile()) {
                     log.debug("===========Optional.emty 가 나옴!!===========");
                      return Optional.empty();
                  }else {
                      try(FileOutputStream fos = new FileOutputStream(convertFiles[i])) {
                          fos.write(file.get(i).getBytes());
                      }
                  }
              }
          }
          return Optional.of(convertFiles);
      }
  ```

  이런식인데 배포를 Linux환경에서 Multipart를 File로 변환을 하려면 권한이 있어야 한다는 점을 깨달았다! 그래서 권한을 주면서 File을 만들어 보았지만 부분적으로 해결은 했지만 결론적인 해결 x 

  - 2차 해결방안 : 블로그를 보다보니 굳이 Multipart -> File로 안하고 바로 Multipart를 사용해도 된다는 것이다!!... 분명히.. 안된다고 블로그에서 봤었는데.. 그래서 다음과 같이 코드를 수정하였다. 

    ```java
    public List<String> boardUpload(List<MultipartFile> multipartFile, String dirName) throws IOException {
            String[] result = changeUploadFileName(multipartFile, dirName);
            return Arrays.asList(result);
        }
    ```

    그냥 다이렉트로 Multipart를 사용해도 문제가 없었던것이다!!




